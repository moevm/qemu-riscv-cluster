# Инструкция по развертыванию системы

## Архитектура системы

Система состоит из следующих компонентов:
1. Несколько виртуальных машин с Linux
2. Контроллер - центральный компонент управления (Go)
   - Управляет worker'ами через Unix-сокеты
   - Обеспечивает распределение задач
3. Worker'ы - компоненты обработки (C++)
   - Подключаются к контроллеру через Unix-сокеты
   - Выполняют вычисление хешей
4. Система мониторинга (Grafana, Prometheus, Loki)

## Порядок развертывания

### 1. Подготовка окружения

На хост-машине должны быть установлены:
- Linux с поддержкой KVM
- Docker и Docker Compose


### 2. Создание базовых образов с помощью Yocto

1. Подготовка Yocto-слоев: Создание собственного слоя для наших компонентов
2. Настройка слоя для контроллера
3. Настройка слоя для worker'а
4. Сборка образов


### 3. Запуск виртуальных машин

1. В файле ports.conf указываются порты для каждой VM (по одному порту на строку)
2. Скрипт run.sh читает этот файл и запускает соответствующее количество VM
3. Для каждой VM настраивается проброс портов SSH
4. Первая VM (первый порт в списке) будет использоваться для контроллера
5. Остальные VM будут использоваться для worker'ов

### 4. Запуск системы мониторинга

На хост-машине запускается стек мониторинга(с помощью docker-compose):
1. Grafana - для визуализации
2. Prometheus - для сбора метрик
3. Loki - для сбора логов

### 5. Развертывание контроллера

На первой VM запускается контроллер через docker-compose:
* Компиляция Go кода через Bazel в контейнере
* Использование подготовленного Yocto-образа для запуска
* Настройка volume для Unix-сокета
* Экспорт метрик для Prometheus
* Отправка логов в Loki


### 6. Развертывание worker'ов

На каждой VM запускается worker через docker-compose:
* Компиляция C++ кода через Bazel в контейнере
* Использование подготовленного Yocto-образа для запуска
* Подключение к Unix-сокету контроллера
* Экспорт метрик для Prometheus
* Отправка логов в Loki


### 7. Проверка работоспособности

1. В Grafana проверяется:
   - Статус контроллера
   - Статус каждого worker'а
   - Метрики производительности
   - Системные ресурсы

2. В логах контроллера проверяется:
   - Создание Unix-сокета
   - Подключение worker'ов
   - Отсутствие ошибок взаимодействия

### 8. Управление системой

Основные операции управления:
1. Остановка/запуск отдельных worker'ов
2. Перезапуск контроллера при необходимости
3. Полная остановка системы в следующем порядке:
   - Остановка всех worker'ов
   - Остановка контроллера
   - Остановка виртуальных машин
   - Остановка системы мониторинга

### 9. Устранение неполадок

При возникновении проблем проверяется:
1. Доступность SSH для управления VM
2. Наличие и права доступа к Unix-сокету
3. Логи контроллера на предмет ошибок IPC
4. Логи worker'ов для проверки подключения
5. Метрики в Prometheus
6. Состояние Docker контейнеров

## Важные замечания

1. Порядок запуска важен: сначала контроллер, затем worker'ы
2. Базовые образы создаются с помощью Yocto для оптимизации и минимизации размера
3. Docker-образы используют минимальные базовые образы из Yocto
4. Коммуникация между контроллером и worker'ами через Unix-сокеты
5. SSH используется только для управления VM
6. Мониторинг осуществляется централизованно через Grafana
7. Сборка компонентов происходит через Bazel внутри Docker с использованием оптимизированных Yocto-образов
8. При обновлении кода:
   - Пересборка соответствующего Docker-образа
   - Обновление контейнеров в системе
